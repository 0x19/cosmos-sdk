# Update to Cosmos-SDK v0.40

The following document describes the changes, and an approach to update the chain to use Cosmos-SDK v0.40 
aka stargate release.

## Contents
- [Updating a module to use Cosmos-SDK v0.40](#updating-a-module-to-use-cosmos-sdk-v040)
- [Updating a cosmos-sdk chain to use SDK v0.40](#updating-a-cosmos-sdk-chain-to-use-sdk-v040)
- [Upgrading a live chain to v0.40](#upgrading-a-live-chain-to-v040)

## Updating a module to use Cosmos-SDK v0.40
This section covers the changes in modules from `v0.39.x` to `v0.40`.
### State
- `internal` package is removed and `types`, `keeper` are moved to module level
- `alias` usage is removed [#6311](https://github.com/cosmos/cosmos-sdk/issues/6311)
#### types/codec.go
- `codec.New()` is changed to `codec.NewLegacyAmino()`.
- Added `RegisterInterfaces` method in which we add `RegisterImplementations` and `RegisterInterfaces` based on msgs and interfaces in module.

    ```go
    func RegisterInterfaces(registry types.InterfaceRegistry) {
        registry.RegisterImplementations((*sdk.Msg)(nil),
            &MsgSend{},
            &MsgMultiSend{},
        )

        registry.RegisterInterface(
            "cosmos.bank.v1beta1.SupplyI",
            (*exported.SupplyI)(nil),
            &Supply{},
        )
    }
    ```
- `init()` changed from:
    ```go
    func init() {
	    RegisterCodec(cdc)
    }
    ```
    to:
    ```go
    func init() {
	    RegisterLegacyAminoCodec(amino)
	    cryptocodec.RegisterCrypto(amino)
    }
    ```
#### Keeper
The `Keeper` constructor now takes a `codec.Marshaler` instead of a concrete Amino codec. This exact type provided is specified by `ModuleCdc`.

#### module.go
* `type AppModuleBasic struct{}` is  updated to:

    ```go
    type AppModuleBasic struct {
        cdc codec.Marshaler
    }
    ```
* `RegisterCodec(cdc *codec.Codec)` method is changed to `RegisterLegacyAminoCodec(cdc *codec.LegacyAmino)`
* Added `RegisterInterfaces` method which implements `AppModuleBasic` which takes one parameter of type `"github.com/cosmos/cosmos-sdk/codec/types".InterfaceRegistry`. This method is used for registering interface types of module.
    ```go
    func (AppModuleBasic) RegisterInterfaces(registry cdctypes.InterfaceRegistry) {
        // register all interfaces in module.
	    types.RegisterInterfaces(registry) //module's types/codec.go
    }
    ````
* `DefaultGenesis()` takes codec input now
    ```go
    func (AppModuleBasic) DefaultGenesis(cdc codec.JSONMarshaler) json.RawMessage {}
    ```
* `ValidateGenesis` now requires `Marshaler`, `TxEncodingConfig`, `json.RawMessage` as input.
    ```go
    func (AppModuleBasic) ValidateGenesis(cdc codec.JSONMarshaler, config client.TxEncodingConfig, bz json.RawMessage) error {}
    ```
* `GetQueryCmd(cdc *codec.Codec)`,`GetTxCmd(cdc *codec.Codec)` is changed to `GetQueryCmd()`,`GetTxCmd()` respectively.
* Return type of `Route()` method which implements `AppModule` is changed from `string` to `"github.com/cosmos/cosmos-sdk/types".Route`. We will return a NewRoute which includes `RouterKey` and `NewHandler` as params.
    ```go
    func (am AppModule) Route() sdk.Route {
        return sdk.NewRoute(types.RouterKey, handler.NewHandler(am.keeper))
    }
    ```
* `QuerierHandler` is renamed to `LegacyQuerierHandler`.
  ```go
    func (am AppModule) LegacyQuerierHandler(legacyQuerierCdc *codec.LegacyAmino) sdk.Querier {}
  ```

* `RegisterServices` is added newly and it registers module's `MsgServer` and gRPC's `QueryServer`.
  ```go
  func (am AppModule) RegisterServices(cfg module.Configurator) {
      types.RegisterMsgServer(cfg.MsgServer(), keeper.NewMsgServerImpl(am.keeper))
      types.RegisterQueryServer(cfg.QueryServer(), am.keeper)
  }
  ```
* `RegisterGRPCGatewayRoutes` is added newly which is for registering module's gRPC gateway routes with API Server.`RegisterQueryHandlerClient` is auto generated by proto code generator.
    ```go
    // RegisterGRPCGatewayRoutes registers the gRPC Gateway routes for the bank module.
    func (AppModuleBasic) RegisterGRPCGatewayRoutes(clientCtx client.Context, mux *runtime.ServeMux) {
        types.RegisterQueryHandlerClient(context.Background(), mux, types.NewQueryClient(clientCtx))
    }
    ```
* `InitGenesis` and `ExportGenesis` require explicit codec input.
    ```go
    func (am AppModule) InitGenesis(ctx sdk.Context, cdc codec.JSONMarshaler, data json.RawMessage) []abci.ValidatorUpdate {}
    func (am AppModule) ExportGenesis(ctx sdk.Context, cdc codec.JSONMarshaler) json.RawMessage {}
    ```
### Querier
Stargate comes with new API service, gRPC. Module keeper implements the gRPC's `QueryServer` interface. 
Every module now has a `keeper/grpc_query.go` which contains the querier implementations. All the module query services
are defined in module's `query.proto` file. Here's an example for defining the query service:

/*cosmos/bank/v1beta1/query.proto*/
```go
// Query defines the gRPC querier service.
service Query {
    // AllBalances queries the balance of all coins for a single account.
    rpc AllBalances(QueryAllBalancesRequest) returns (QueryAllBalancesResponse) {
        option (google.api.http).get = "/cosmos/bank/v1beta1/balances/{address}";
    }
  ...
}

// QueryAllBalancesRequest is the request type for the Query/AllBalances RPC method.
message QueryAllBalancesRequest {
  option (gogoproto.equal)           = false;
  option (gogoproto.goproto_getters) = false;

  // address is the address to query balances for.
  string address = 1;

  // pagination defines an optional pagination for the request.
  cosmos.base.query.v1beta1.PageRequest pagination = 2;
}

// QueryAllBalancesResponse is the response type for the Query/AllBalances RPC
// method.
message QueryAllBalancesResponse {
  // balances is the balances of all the coins.
  repeated cosmos.base.v1beta1.Coin balances = 1
      [(gogoproto.nullable) = false, (gogoproto.castrepeated) = "github.com/cosmos/cosmos-sdk/types.Coins"];

  // pagination defines the pagination in the response.
  cosmos.base.query.v1beta1.PageResponse pagination = 2;
}
```

`0.40` comes with an efficient querier pagination, it now uses `Prefix` stores to query. 
There are 2 helpers for `pagination`, 1) `Paginate` 2) `FilteredPaginate`.

### Client
- `context.CLIContext` is renamed to `client.Context` and moved to `github.com/cosmos/cosmos-sdk/client`
- The global `viper` usage is removed from client and is replaced with Cobra' `cmd.Flags()`. There are two helpers 
to read common flags for CLI txs and queries. 
```go
clientCtx, err := client.ReadTxCommandFlags(clientCtx, cmd.Flags())
clientCtx, err := client.ReadQueryCommandFlags(clientCtx, cmd.Flags())
```
- Flags helper functions `flags.PostCommands(cmds ...*cobra.Command) []*cobra.Command`, `flags.GetCommands(...)` usage
 is now replaced by `flags.AddTxFlagsToCmd(cmd *cobra.Command)` and `flags.AddQueryFlagsToCmd(cmd *cobra.Command)` 
 respectively. 
- New CLI tx commands doesn't take `codec` as an input now. 
```go
// v0.39.x
func SendTxCmd(cdc *codec.Codec) *cobra.Command {
	...
}

// v0.40
func NewSendTxCmd() *cobra.Command {
	...
}
```
*Sample code for new tx command:*
```go
// NewSendTxCmd returns a CLI command handler for creating a MsgSend transaction.
func NewSendTxCmd() *cobra.Command {
	cmd := &cobra.Command{
		Use: "send [from_key_or_address] [to_address] [amount]",
		Short: `Send funds from one account to another. Note, the'--from' flag is
ignored as it is implied from [from_key_or_address].`,
		Args: cobra.ExactArgs(3),
		RunE: func(cmd *cobra.Command, args []string) error {
			cmd.Flags().Set(flags.FlagFrom, args[0])

			clientCtx := client.GetClientContextFromCmd(cmd)
			clientCtx, err := client.ReadTxCommandFlags(clientCtx, cmd.Flags())
			if err != nil {
				return err
			}

			toAddr, err := sdk.AccAddressFromBech32(args[1])
			if err != nil {
				return err
			}

			coins, err := sdk.ParseCoins(args[2])
			if err != nil {
				return err
			}

			msg := types.NewMsgSend(clientCtx.GetFromAddress(), toAddr, coins)
			if err := msg.ValidateBasic(); err != nil {
				return err
			}

			return tx.GenerateOrBroadcastTxCLI(clientCtx, cmd.Flags(), msg)
		},
	}

	flags.AddTxFlagsToCmd(cmd)

	return cmd
}
```

## Updating a cosmos-sdk chain to use SDK 0.40

## Upgrading a live chain to v0.40

References:
- [ADR 019 - Protobuf State Encoding](https://github.com/cosmos/cosmos-sdk/blob/master/docs/architecture/adr-019-protobuf-state-encoding.md)
- [ADR 020 - Protobuf Transaction Encoding](https://github.com/cosmos/cosmos-sdk/blob/master/docs/architecture/adr-020-protobuf-transaction-encoding.md)
- [ADR 021 - Protobuf Query Encoding](https://github.com/cosmos/cosmos-sdk/blob/master/docs/architecture/adr-021-protobuf-query-encoding.md)
- [ADR 023 - Protobuf Naming](https://github.com/cosmos/cosmos-sdk/blob/master/docs/architecture/adr-023-protobuf-naming.md)
- [ADR 031 - Protobuf Msg Services](https://github.com/cosmos/cosmos-sdk/blob/master/docs/architecture/adr-031-msg-service.md)